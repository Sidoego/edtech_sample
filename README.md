# Ежедневная аналитическая система для EdTech-продукта

## Общий подход

Система аналитики реализована по принципу ежедневной (batch) обработки событий. Все метрики рассчитываются один раз в сутки, что обеспечивает:

- Простую и устойчивую архитектуру
- Снижение нагрузки на инфраструктуру
- Минимальную операционную сложность
- Отсутствие необходимости в потоковых компонентах (Kafka, Flink и т.д.)

## Архитектура

### Компоненты

- **Хранилище**: ClickHouse
- **Оркестрация**: Apache Airflow
- **Трансформации**: Python (загрузка), dbt (бизнес-логика)
- **Формат исходных данных**: JSON Lines (`.jsonl`)
- **Облачное хранилище**: S3

### Основные DAG'и

#### 1. `load_raw_data`

- Ожидает появление файла с сырыми событиями в S3
- Загружает файл на локальную файловую систему
- Вызывает Python-скрипт `parse_raw_events_with_ch.py`, который:
  - Выполняет парсинг и валидацию JSONL
  - Делит данные по сущностям
  - Загружает данные в таблицы ClickHouse в схеме `raw`

#### 2. `run_dbt_analytics`

- Запускается после успешного завершения `load_raw_data`
- Выполняет `dbt run` для пересчёта всех аналитических моделей:
  - Подготовка (`staging`)
  - Мартовые модели (`marts`)

## Слой `raw`

После загрузки все события разбиваются на нормализованные таблицы:

| Таблица                    | Назначение                                 |
|----------------------------|--------------------------------------------|
| `raw.events`               | Общие пользовательские события             |
| `raw.purchases`            | Факт покупок подписок                      |
| `raw.task_results`         | Результаты решения задач                   |
| `raw.sessions`             | Сессии пользователей                       |
| `raw.ab_test_assignments` | Назначения в A/B-тесты                     |

## Структура dbt-проекта

| Слой       | Назначение                                   |
|------------|----------------------------------------------|
| `staging/` | Приведение данных к стандартизированной форме |
| `marts/`   | Расчёт продуктовых и бизнесовых метрик        |

## Основные метрики

- **Активность пользователей**: DAU, WAU, MAU, коэффициенты DAU/WAU/MAU
- **Образовательная эффективность**: доля успешно решённых задач
- **Retention**: когортный анализ
- **Финансовые показатели**: конверсия, ARPU, LTV, ретеншн подписок
- **A/B тестирование**: сравнение групп по целевым метрикам

## План выполнения

- `load_raw_data`: ежедневно, в ночное время (например, 02:00)
- `run_dbt_analytics`: запускается по завершении загрузки

## Обоснование

Данный подход обеспечивает достаточную частоту обновления аналитики при минимальной сложности инфраструктуры. Все бизнесовые задачи решаются средствами batch-обработки.

> Batch-подход остаётся предпочтительным при отсутствии необходимости в real-time-аналитике.
